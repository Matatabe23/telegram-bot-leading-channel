#!/usr/bin/env bash
set -e

APP_DIR="/home/prod"
NGINX_TEMPLATE="$APP_DIR/nginx.conf.template"
NGINX_CONFIG="$APP_DIR/nginx.conf"

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
cd "$APP_DIR" || exit 1

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞ —ç—Ç–∞–ø–æ–≤
log() {
    echo -e "\n=== $1 ===\n"
}

# –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è
log "üöÄ –î–µ–ø–ª–æ–π –Ω–∞—á–∞—Ç: $(date)"

# –°–±—Ä–æ—Å –∏ —Å—Ç—è–≥–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
log "‚û§ –°–±—Ä–æ—Å –∏ —Å—Ç—è–≥–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏..."
git fetch
git reset --hard origin/main
git pull

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è nginx.conf –∏–∑ —à–∞–±–ª–æ–Ω–∞
log "‚û§ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è nginx.conf –∏–∑ —à–∞–±–ª–æ–Ω–∞..."
set -o allexport
source <(grep -v '^#' .env | tr -d '\r')
set +o allexport
envsubst '${MY_DOMAIN}' < "$NGINX_TEMPLATE" > "$NGINX_CONFIG"
log "‚úÖ nginx.conf —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ."

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏)
log "‚û§ –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose build --no-cache

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
log "‚û§ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker compose up -d

# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–µ–ø–ª–æ—è
log "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω: $(date)"
